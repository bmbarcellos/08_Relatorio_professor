<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relatório Gerencial – Prova Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background-color: #f2f4f7;
      margin: 0;
      padding: 24px;
      color: #111;
    }

    h1, h2 {
      color: #003366;
      margin-top: 0;
    }

    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }

    .metric {
      text-align: center;
      padding: 14px;
      border-radius: 6px;
      background: #f8f9fb;
    }

    .metric strong {
      display: block;
      font-size: 1.8rem;
      color: #003366;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 13px;
      text-align: center;
    }

    th {
      background: #e9eef3;
    }

    .violacao {
      color: #b00020;
      font-weight: bold;
      font-size: 12px;
    }

    .footer {
      margin-top: 24px;
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .error {
      color: #b00020;
      font-weight: bold;
      text-align: center;
      margin-top: 40px;
    }
  </style>
</head>

<body>

<h1>Relatório Gerencial da Prova Digital</h1>
<p>Universidade Federal Fluminense</p>

<div id="conteudo"></div>

<div class="footer">
  Relatório gerado automaticamente pelo sistema de provas digitais
</div>

<script>
  const container = document.getElementById("conteudo");

  const dados = JSON.parse(localStorage.getItem("relatorio_dados"));

  if (!dados) {
    container.innerHTML =
      "<p class='error'>Dados do relatório não encontrados. Retorne à página inicial.</p>";
    throw new Error("relatorio_dados ausente");
  }

  // ===============================
  // PROCESSA ALUNOS E VIOLAÇÕES
  // ===============================
  const alunos = dados.alunos.map(a => {
    let violacoes = {};
    try {
      violacoes = typeof a.violacoes === "string"
        ? JSON.parse(a.violacoes)
        : a.violacoes || {};
    } catch {
      violacoes = {};
    }

    return { ...a, violacoes };
  });

  // ===============================
  // HTML
  // ===============================
  container.innerHTML = `
    <div class="card">
      <div class="grid">
        <div class="metric">
          <strong>${dados.total_alunos}</strong>
          Alunos avaliados
        </div>
        <div class="metric">
          <strong>${dados.media_turma}</strong>
          Média da turma
        </div>
        <div class="metric">
          <strong>${dados.tempo_medio_min} min</strong>
          Tempo médio
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Resultados por Aluno</h2>
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Matrícula</th>
            <th>Nota</th>
            <th>Tempo (min)</th>
            <th>Violações</th>
          </tr>
        </thead>
        <tbody>
          ${alunos.map(a => `
            <tr>
              <td>${a.nome}</td>
              <td>${a.matricula}</td>
              <td>${a.nota}</td>
              <td>${a.duracao_min}</td>
              <td class="violacao">
                ${
                  Object.keys(a.violacoes).length
                    ? Object.entries(a.violacoes)
                        .map(v => `${v[0]} (${v[1]})`)
                        .join("<br>")
                    : "—"
                }
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
</script>

</body>
</html>
