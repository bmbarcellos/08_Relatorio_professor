<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relatório da Prova – Universidade Federal Fluminense</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background-color: #f4f6f8;
      color: #1a1a1a;
    }

    header {
      background-color: #003366;
      color: #fff;
      padding: 16px 24px;
      font-size: 20px;
      font-weight: bold;
    }

    .container {
      padding: 24px;
      max-width: 1200px;
      margin: auto;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .kpi {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .kpi h3 {
      margin: 0;
      font-size: 14px;
      color: #555;
    }

    .kpi p {
      margin: 8px 0 0;
      font-size: 24px;
      font-weight: bold;
      color: #003366;
    }

    .grafico {
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 32px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      font-size: 14px;
    }

    th {
      background-color: #003366;
      color: #fff;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    tr.violou {
      background-color: #fff1f1;
    }

    .violacao {
      font-size: 12px;
      color: #b00020;
      line-height: 1.4;
    }

    footer {
      margin-top: 48px;
      text-align: center;
      font-size: 12px;
      color: #777;
    }
  </style>
</head>

<body>

<header>
  Universidade Federal Fluminense – Relatório da Prova
</header>

<div class="container" id="conteudo">
  <p>Carregando relatório…</p>
</div>

<footer>
  Sistema de Provas Digitais – UFF
</footer>

<script>
/* ===============================
   UTILIDADES
================================ */

function parseViolacoes(v) {
  if (!v) return {};
  if (typeof v === "object") return v;
  try {
    return JSON.parse(v);
  } catch {
    return {};
  }
}

/* ===============================
   BUSCA DADOS
================================ */

async function carregarRelatorio() {
  const payload = localStorage.getItem("relatorio_payload");

  if (!payload) {
    document.getElementById("conteudo").innerHTML =
      "<p>Dados do relatório não encontrados.</p>";
    return;
  }

  let params;
  try {
    params = JSON.parse(payload);
  } catch {
    document.getElementById("conteudo").innerHTML =
      "<p>Payload inválido.</p>";
    return;
  }

  const url = `https://webhook.artideia.com.br/webhook/relatorio_professor?email=${encodeURIComponent(params.email)}&senha=${encodeURIComponent(params.senha)}&prova_id=${encodeURIComponent(params.prova_id)}`;

  try {
    const res = await fetch(url);
    const text = await res.text();

    let data;
    try {
      data = JSON.parse(text);
    } catch {
      document.getElementById("conteudo").innerHTML =
        `<p>${text}</p>`;
      return;
    }

    if (Array.isArray(data)) {
      data = data[0];
    }

    renderizarRelatorio(data);
    localStorage.removeItem("relatorio_payload");

  } catch (e) {
    document.getElementById("conteudo").innerHTML =
      "<p>Erro ao carregar o relatório.</p>";
  }
}

/* ===============================
   RENDERIZAÇÃO
================================ */

function renderizarRelatorio(d) {

  const mediaAcerto =
    d.questoes.reduce((s, q) => s + q.percentual_acerto, 0) / d.questoes.length;

  const html = `
    <div class="kpis">
      <div class="kpi">
        <h3>Total de alunos</h3>
        <p>${d.total_alunos}</p>
      </div>
      <div class="kpi">
        <h3>Média da turma</h3>
        <p>${d.media_turma.toFixed(2)}</p>
      </div>
      <div class="kpi">
        <h3>Maior nota</h3>
        <p>${d.maior_nota}</p>
      </div>
      <div class="kpi">
        <h3>Menor nota</h3>
        <p>${d.menor_nota}</p>
      </div>
      <div class="kpi">
        <h3>Acerto médio</h3>
        <p>${mediaAcerto.toFixed(1)}%</p>
      </div>
    </div>

    <div class="grafico">
      <canvas id="graficoQuestoes"></canvas>
    </div>

    <div class="grafico">
      <canvas id="boxplotNotas"></canvas>
    </div>

    <h2>Resultados individuais</h2>

    <table>
      <thead>
        <tr>
          <th>Aluno</th>
          <th>Nota</th>
          <th>Violações</th>
        </tr>
      </thead>
      <tbody>
        ${d.alunos
          .sort((a, b) => b.nota - a.nota)
          .map(a => {
            const viol = parseViolacoes(a.violacoes);
            return `
              <tr class="${Object.keys(viol).length ? "violou" : ""}">
                <td>${a.aluno}</td>
                <td>${a.nota}</td>
                <td class="violacao">
                  ${Object.keys(viol).length
                    ? Object.entries(viol)
                        .map(([k, v]) => `${k} (${v})`)
                        .join("<br>")
                    : "—"}
                </td>
              </tr>
            `;
          }).join("")}
      </tbody>
    </table>
  `;

  document.getElementById("conteudo").innerHTML = html;

  /* ===============================
     GRÁFICOS
  ================================ */

  new Chart(document.getElementById("graficoQuestoes"), {
    type: "bar",
    data: {
      labels: d.questoes.map((_, i) => `Q${i + 1}`),
      datasets: [{
        label: "Percentual de acerto (%)",
        data: d.questoes.map(q => q.percentual_acerto)
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, max: 100 }
      }
    }
  });

  new Chart(document.getElementById("boxplotNotas"), {
    type: "boxplot",
    data: {
      labels: ["Distribuição de notas"],
      datasets: [{
        label: "Notas",
        data: [d.alunos.map(a => a.nota)]
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, max: 10 }
      }
    }
  });
}

/* ===============================
   INIT
================================ */

carregarRelatorio();
</script>

</body>
</html>
