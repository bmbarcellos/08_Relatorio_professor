<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Prova Digital – UFF</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --uff-blue: #002f6c;
  --uff-light: #f2f6fb;
  --card-bg: #ffffff;
  --border: #e0e6ef;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: var(--uff-light);
  color: #222;
}

header {
  background: var(--uff-blue);
  color: #fff;
  padding: 20px;
}

header h1 {
  margin: 0;
  font-size: 22px;
}

header h2 {
  margin: 4px 0 0;
  font-size: 14px;
  font-weight: normal;
}

main {
  padding: 24px;
  max-width: 1200px;
  margin: auto;
}

.card {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  margin-bottom: 24px;
}

/* ===== RESUMO DA PROVA ===== */
.resumo-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.resumo-coluna {
  display: grid;
  grid-template-columns: auto 1fr;
  row-gap: 10px;
  column-gap: 16px;
  align-items: center;
}

.resumo-coluna strong {
  font-weight: 600;
  white-space: nowrap;
}

.resumo-valor {
  text-align: center;
  font-weight: bold;
  color: var(--uff-blue);
}

/* ===== GRÁFICOS ===== */
.graficos {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

canvas {
  max-height: 260px;
}

/* ===== TABELA ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid var(--border);
  text-align: center;
}

th {
  background: #f0f4fa;
}

.violation-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  background: #e9edf5;
}

.violation-badge.alert {
  background: #ffe5e5;
  color: #b00000;
}
</style>
</head>

<body>

<header>
  <h1>Universidade Federal Fluminense</h1>
  <h2>Sistema de Prova Digital – Dashboard do Professor</h2>
</header>

<main>

<!-- RESUMO DA PROVA -->
<div class="card">
  <h3>Resumo da Prova</h3>

  <div class="resumo-grid" id="resumoProva"></div>
</div>

<!-- GRÁFICOS -->
<div class="card">
  <h3>Distribuição de Notas</h3>

  <div class="graficos">
    <canvas id="boxplotNotas"></canvas>
    <canvas id="histogramaNotas"></canvas>
  </div>
</div>

<!-- TABELA DE ALUNOS -->
<div class="card">
  <h3>Resultados dos Alunos</h3>

  <table>
    <thead>
      <tr>
        <th>Aluno</th>
        <th>Matrícula</th>
        <th>Nota</th>
        <th>Duração (min)</th>
        <th>Violações</th>
      </tr>
    </thead>
    <tbody id="tabelaAlunos"></tbody>
  </table>
</div>

</main>

<script>
const dados = JSON.parse(localStorage.getItem("relatorio_professor"))?.[0];
if (!dados) {
  alert("Dados do relatório não encontrados.");
  throw new Error("Sem dados");
}

const notas = dados.alunos.map(a => a.nota);
const media = dados.media_turma;
const min = Math.min(...notas);
const max = Math.max(...notas);
const desvio = Math.sqrt(
  notas.reduce((s,n)=>s + Math.pow(n-media,2),0) / notas.length
).toFixed(2);

const acima = notas.filter(n => n >= media).length;
const abaixo = notas.filter(n => n < media).length;

/* ===== RESUMO ===== */
document.getElementById("resumoProva").innerHTML = `
  <div class="resumo-coluna">
    <strong>Prova ID</strong><div class="resumo-valor">${dados.prova_id}</div>
    <strong>Total de alunos</strong><div class="resumo-valor">${dados.total_alunos}</div>
    <strong>Nº de questões</strong><div class="resumo-valor">${dados.questoes.length}</div>
    <strong>Duração da prova</strong><div class="resumo-valor">${dados.tempo_medio_min} min</div>
  </div>

  <div class="resumo-coluna">
    <strong>Média da turma</strong><div class="resumo-valor">${media}</div>
    <strong>Desvio padrão</strong><div class="resumo-valor">${desvio}</div>
    <strong>Nota mínima</strong><div class="resumo-valor">${min}</div>
    <strong>Nota máxima</strong><div class="resumo-valor">${max}</div>
    <strong>Acima da média</strong><div class="resumo-valor">${acima}</div>
    <strong>Abaixo da média</strong><div class="resumo-valor">${abaixo}</div>
  </div>
`;

/* ===== TABELA ===== */
dados.alunos
  .sort((a,b)=>a.nome.localeCompare(b.nome))
  .forEach(a=>{
    const violacoes = JSON.parse(a.violacoes || "{}");
    const qtd = Object.values(violacoes).reduce((s,v)=>s+v,0);

    const badge = qtd > 0
      ? `<span class="violation-badge alert">${qtd} evento(s)</span>`
      : `<span class="violation-badge">Nenhuma</span>`;

    document.getElementById("tabelaAlunos").innerHTML += `
      <tr>
        <td>${a.nome}</td>
        <td>${a.matricula}</td>
        <td>${a.nota}</td>
        <td>${a.duracao_min}</td>
        <td>${badge}</td>
      </tr>
    `;
  });

/* ===== HISTOGRAMA ===== */
new Chart(document.getElementById("histogramaNotas"), {
  type: "bar",
  data: {
    labels: notas,
    datasets: [{
      data: notas
    }]
  },
  options: {
    plugins: { legend: { display: false }},
    scales: { y: { beginAtZero: true }}
  }
});

/* ===== BOXPLOT SIMPLES (simulado) ===== */
new Chart(document.getElementById("boxplotNotas"), {
  type: "bar",
  data: {
    labels: ["Min","Q1","Mediana","Q3","Max"],
    datasets: [{
      data: [
        min,
        notas.sort((a,b)=>a-b)[Math.floor(notas.length*0.25)],
        notas.sort((a,b)=>a-b)[Math.floor(notas.length*0.5)],
        notas.sort((a,b)=>a-b)[Math.floor(notas.length*0.75)],
        max
      ]
    }]
  },
  options: {
    plugins: { legend: { display: false }},
    scales: { y: { beginAtZero: true }}
  }
});
</script>

</body>
</html>
